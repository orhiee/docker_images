<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NAS Remote Connection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #container {
      max-width: 600px;
      margin: 0 auto;
    }
    input, button {
      padding: 8px;
      font-size: 1rem;
    }
    #status {
      margin-top: 10px;
      color: #555;
    }
    #iframeContainer {
      margin-top: 20px;
      display: none;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>Connect to NAS Service</h2>
    <input type="text" id="connectionCode" placeholder="Enter connection code">
    <button id="connectBtn">Connect</button>
    <div id="status"></div>
  </div>
  <div id="iframeContainer">
    <h3>Remote Service Interface</h3>
    <iframe id="remoteInterface" src=""></iframe>
  </div>

  <script>
    (function() {
      'use strict';

      // Configuration for WebRTC and signaling
      // const signalingServerUrl = 'wss://your.signaling.server'; // Replace with your central signaling server URL https://orhiee.github.io/docker_images/nas-connect.html
      // const signalingServerUrl = 'https://orhiee.github.io/docker_images/nas-connect.html'; // Replace with your central signaling server URL
      const signalingServerUrl = 'wss://orhiee.github.io/docker_images/nas-connect.html'; // Replace with your central signaling server URL
      const rtcConfiguration = {
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      };

      let websocket;
      let peerConnection;
      const connectionCodeInput = document.getElementById('connectionCode');
      const connectBtn = document.getElementById('connectBtn');
      const statusEl = document.getElementById('status');
      const iframeContainer = document.getElementById('iframeContainer');
      const remoteInterfaceIframe = document.getElementById('remoteInterface');

      // Utility: update status message
      function setStatus(message) {
        statusEl.textContent = message;
        console.log(message);
      }

      // Utility: log and display errors
      function handleError(error) {
        console.error(error);
        setStatus('Error: ' + error);
      }

      // Signaling: send a JSON message via WebSocket
      function sendMessage(message) {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(JSON.stringify(message));
        }
      }

      // Initialize and configure the RTCPeerConnection
      function initPeerConnection() {
        peerConnection = new RTCPeerConnection(rtcConfiguration);

        // Handle local ICE candidates by sending them to the signaling server
        peerConnection.onicecandidate = function(event) {
          if (event.candidate) {
            sendMessage({
              type: 'ice',
              candidate: event.candidate
            });
          }
        };

        // Monitor connection state and load remote service interface upon success
        peerConnection.onconnectionstatechange = function() {
          const state = peerConnection.connectionState;
          console.log('Peer connection state:', state);
          if (state === 'connected') {
            setStatus('Peer connection established.');
            loadRemoteInterface();
          } else if (state === 'failed' || state === 'disconnected') {
            setStatus('Peer connection failed or disconnected.');
          }
        };
      }

      // Create and send a WebRTC offer
      function createAndSendOffer() {
        peerConnection.createOffer()
          .then(offer => peerConnection.setLocalDescription(offer))
          .then(() => {
            sendMessage({
              type: 'offer',
              offer: peerConnection.localDescription
            });
          })
          .catch(handleError);
      }

      // Process an incoming answer
      function handleAnswer(data) {
        if (data.answer) {
          peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer))
            .catch(handleError);
        }
      }

      // Add a received ICE candidate
      function handleRemoteICECandidate(candidate) {
        if (candidate) {
          peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
            .catch(handleError);
        }
      }

      // Establish WebSocket connection and initiate WebRTC signaling
      function startConnection(connectionCode) {
        websocket = new WebSocket(signalingServerUrl);

        websocket.onopen = function() {
          setStatus('Connected to signaling server.');
          // Identify the session using the user-provided connection code
          sendMessage({ type: 'join', code: connectionCode });
          initPeerConnection();
          createAndSendOffer();
        };

        websocket.onerror = function() {
          handleError('WebSocket connection error.');
        };

        websocket.onmessage = function(event) {
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (err) {
            console.error('Invalid JSON:', event.data);
            return;
          }
          if (!data || !data.type) return;

          switch (data.type) {
            case 'answer':
              handleAnswer(data);
              break;
            case 'ice':
              handleRemoteICECandidate(data.candidate);
              break;
            // The "offer" case is unlikely in this role, but can be handled if needed.
            default:
              break;
          }
        };

        websocket.onclose = function() {
          setStatus('Disconnected from signaling server.');
        };
      }

      // Once the peer connection is established, load the remote HTTP interface.
      // This example loads a URL in an iframe; adjust the URL or embedding method as needed.
      function loadRemoteInterface() {
        // const remoteUrl = 'https://remote.nas.service/interface'; // Replace with dynamic URL if provided via signaling http://192.168.0.2:88/admin/index.php
        const remoteUrl = 'http://192.168.0.2:88/admin/index.php'; // Replace with dynamic URL if provided via signaling
        remoteInterfaceIframe.src = remoteUrl;
        iframeContainer.style.display = 'block';
      }

      // UI event: on clicking the "Connect" button, start the connection process.
      connectBtn.addEventListener('click', function() {
        const code = connectionCodeInput.value.trim();
        if (!code) {
          setStatus('Please enter a connection code.');
          return;
        }
        setStatus('Connecting...');
        startConnection(code);
      });
    })();
  </script>
</body>
</html>
